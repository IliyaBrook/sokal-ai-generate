name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Test Secrets
        run: |
          echo "Checking if secrets are available..."
          # Безопасные проверки секретов (без вывода значений)
          if [ -n "${{ secrets.SERVER_IP }}" ]; then
            echo "SERVER_IP is set ✓"
          else
            echo "SERVER_IP is not set! ✗"
          fi
          
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "SSH_PRIVATE_KEY is set ✓"
          else
            echo "SSH_PRIVATE_KEY is not set! ✗"
          fi
          
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            echo "SSH_KNOWN_HOSTS is set ✓"
          else
            echo "SSH_KNOWN_HOSTS is not set! ✗"
          fi
          
          if [ -n "${{ secrets.MONGO_USERNAME }}" ]; then
            echo "MONGO_USERNAME is set ✓"
          else
            echo "MONGO_USERNAME is not set! ✗"
          fi
          
          if [ -n "${{ secrets.MONGO_PASSWORD }}" ]; then
            echo "MONGO_PASSWORD is set ✓"
          else
            echo "MONGO_PASSWORD is not set! ✗"
          fi
          
          if [ -n "${{ secrets.SERVER_PORT }}" ]; then
            echo "SERVER_PORT is set ✓"
          else
            echo "SERVER_PORT is not set! ✗"
          fi
          
          # Проверка сетевых подключений
          echo "Testing network connectivity to 157.180.25.1..."
          ping -c 3 157.180.25.1 || echo "Ping failed"
          
          # Проверка SSH команды
          echo "SSH command info:"
          ssh -V
          
          # Вывод информации об окружении
          echo "Environment details:"
          uname -a
          
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
          
      - name: Debug SSH connection
        run: |
          echo "Debugging SSH connection to 157.180.25.1..."
          # Проверка SSH соединения с известным IP
          ssh -v -o StrictHostKeyChecking=no root@157.180.25.1 "echo 'SSH connection successful'" || echo "SSH connection failed"
          
          # Проверка содержимого known_hosts
          echo "Checking ~/.ssh/known_hosts..."
          cat ~/.ssh/known_hosts || echo "No known_hosts file"
          
          # Проверка прав доступа
          echo "Checking SSH directory permissions..."
          ls -la ~/.ssh/
          
      - name: Create root .env file
        run: |
          echo "MONGO_USERNAME=${{ secrets.MONGO_USERNAME }}" > .env
          echo "MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}" >> .env
          echo "SERVER_PORT=${{ secrets.SERVER_PORT }}" >> .env
          echo "PORT=${{ secrets.SERVER_PORT }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}" >> .env
          echo "JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}" >> .env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          
      - name: Create frontend .env.production file
        run: |
          echo "NEXT_PUBLIC_API_URL=http://${{ secrets.SERVER_IP }}:${{ secrets.SERVER_PORT }}/api" > frontend/.env.production
          
      - name: Create docker-compose.yml
        run: |
          cat > docker-compose.yml << 'EOL'
          version: '3.8'
          
          services:
            mongodb:
              image: mongo:latest
              restart: always
              environment:
                MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
                MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
              volumes:
                - mongodb_data:/data/db
              ports:
                - "27017:27017"
            
            backend:
              build:
                context: .
                dockerfile: backend/Dockerfile
              restart: always
              depends_on:
                - mongodb
              ports:
                - "${SERVER_PORT}:${SERVER_PORT}"
              environment:
                - NODE_ENV=production
            
            frontend:
              build:
                context: .
                dockerfile: frontend/Dockerfile
              restart: always
              depends_on:
                - backend
              ports:
                - "80:3000"
          
          volumes:
            mongodb_data:
          EOL
          
      - name: Install Docker on server (if needed)
        run: |
          echo "Installing Docker on server 157.180.25.1..."
          ssh root@157.180.25.1 "if ! command -v docker &> /dev/null; then apt update && apt install -y docker.io docker-compose && systemctl enable docker && systemctl start docker; fi"
          
      - name: Deploy to Hetzner
        run: |
          # Create project directory
          echo "Creating project directory on 157.180.25.1..."
          ssh root@157.180.25.1 "mkdir -p /root/sokal-ai-generate"
          
          # Copy necessary files
          echo "Copying files to server..."
          scp docker-compose.yml .env .dockerignore root@157.180.25.1:/root/sokal-ai-generate/
          scp -r backend frontend shared-types configs root@157.180.25.1:/root/sokal-ai-generate/
          
          # Run docker-compose on the server
          echo "Starting containers on server..."
          ssh root@157.180.25.1 "cd /root/sokal-ai-generate && docker-compose down && docker-compose up -d --build" 